{% extends "../base.html" %}

{% block title %} {% end %}
{% block css %}
<link rel="stylesheet" href="{{ static_url('cropper/cropper.css') }}">
<style type="text/css">
    .thumb-add p {
        float: left; width: auto; margin: auto 10px;
    }
    .thumb-add .upload-img {
        float: left;
    }
    .thumb-add img {
        margin: -140px auto auto 640px;
        width: 200px;
        float: left;
    }
</style>
{% end %}
{% block body %}
<div class="layui-body" style="padding-top: 0px; padding-left: 10px;">
    <div class="layui-tab">
        <ul class="layui-tab-title">
            <li class="layui-this">基本信息</li>
            <li>其他信息</li>
        </ul>
        <form class="layui-tab-content layui-form layui-form-pane" action="{{ request.uri }}" method="post" id="editForm">
            {% raw xsrf_form_html() %}
            <input type="hidden" class="field-id" name="id">
            <div class="layui-tab-item layui-show">
                <div class="layui-form-item">
                    <label class="layui-form-label">所属分类</label>
                    <div class="layui-input-inline">
                        <select name="category" class="field-category" type="select" lay-filter="category">
                            {% raw category_option_html %}
                        </select>
                    </div>
                    <div class="layui-form-mid layui-word-aux">
                    </div>
                    <label class="layui-form-label">发布时间</label>
                    <div class="layui-input-inline">
                        <input type="text" class="layui-input field-publish_date" name="publish_date" id="publish_date" lay-verify="required" autocomplete="off" placeholder="请选择发布时间">
                    </div>
                    <div class="layui-form-mid layui-word-aux">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">作者</label>
                    <div class="layui-input-inline">
                        <input type="text" class="layui-input field-author" name="author" lay-verify="required" autocomplete="off" placeholder="请输入作者">
                    </div>
                    <div class="layui-form-mid layui-word-aux">
                    </div>
                    <label class="layui-form-label">来源</label>
                    <div class="layui-input-inline">
                        <input type="text" class="layui-input field-source" name="source" lay-verify="required" autocomplete="off" placeholder="请输入来源">
                    </div>
                    <div class="layui-form-mid layui-word-aux">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">缩略图</label>
                    <input type="hidden" class="field-thumb" name="thumb" value="{{article.thumb}}">
                    <div class="thumb-add">
                        <p>建议尺寸313*200，支持jpg、png、gif，最大不能超过80KB</p>
                        <button type="button" class="layui-btn upload-img" id="thumb">
                            <i class="layui-icon">&#xe67c;</i>上传缩略图
                        </button>
                        {% if article.thumb %}
                        <img src="{{ static_url(article.thumb) }}">
                        {% else %}
                        <img alt="313x200" style="height: 200px; width: 313px; display: block;" src="{{static_url('image/313_200.png')}}" data-holder-rendered="true">
                        {% end %}
                        <span class="loading"></span>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">文章标题</label>
                    <div class="layui-input-inline" style="width: 80%;">
                        <input type="text" class="layui-input field-title" name="title" lay-verify="required" autocomplete="off" placeholder="请输入文章标题">
                    </div>
                    <div class="layui-form-mid layui-word-aux">
                        必填，长度限制3-80个字节(1个汉字等于3个字节)
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">文章内容</label>
                    <div class="layui-input-inline" style="width: 80%;">
                        <textarea id="content" class="field-content" name="content" style="display: none;"></textarea>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">状态设置</label>
                    <div class="layui-input-inline">
                        <input type="radio" class="field-status" name="status" value="1" title="启用" checked>
                        <input type="radio" class="field-status" name="status" value="0" title="禁用">
                    </div>
                </div>
            </div>
            <div class="layui-tab-item">
                <div class="layui-form-item">
                    <label class="layui-form-label">外链地址</label>
                    <div class="layui-input-inline" style="width: 82%;">
                        <input type="text" class="layui-input field-external_url" name="external_url" lay-verify="" autocomplete="off" placeholder="外链地址">
                    </div>
                    <div class="layui-form-mid layui-word-aux">
                        选填，http 或者 https 开头的标准URL
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">访问次数</label>
                    <div class="layui-input-inline">
                        <input type="text" class="layui-input field-hits" name="hits" lay-verify="number" autocomplete="off" placeholder="访问次数" >
                    </div>
                    <div class="layui-form-mid layui-word-aux">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">关键词</label>
                    <div class="layui-input-inline">
                        <input type="text" class="layui-input field-keyword" name="keyword" lay-verify="" autocomplete="off" placeholder="关键词">
                    </div>
                    <div class="layui-form-mid layui-word-aux">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">文章简介</label>
                    <div class="layui-input-inline">
                        <textarea name="description" lay-verify="" style="width: 400px; height: 150px;" autocomplete="off" class="layui-textarea field-description"></textarea>
                    </div>
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-input-block">
                    <button type="submit" class="layui-btn" lay-submit="" lay-filter="formSubmit">提交</button>
                    <a href="/admin/menu/index?#category={{ category }}" class="layui-btn layui-btn-primary ml10">
                        <i class="aicon ai-fanhui"></i>返回
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>
{% end %}
{% block javascript %}

<script src="{{ static_url('cropper/cropper.js') }}" charset="utf-8"></script>
<script type="text/javascript">
var formData = {% raw data_info %}

layui.config({
        base: '/static/cropper/' //layui自定义layui组件目录
    }).use(['form', 'laydate', 'upload', 'layedit', 'element', 'croppers'], function() {
    var $ = layui.jquery
    var element = layui.element
    var form = layui.form
    var laydate = layui.laydate
    var upload = layui.upload
    var layedit = layui.layedit
    var croppers = layui.croppers

    laydate.render({
        elem: '#publish_date'
    })


    //创建一个头像上传组件
    croppers.render({
        elem: '#thumb'
        ,tips:'缩略图的尺寸限定313x200px,大小在80kb以内'
        ,saveW:313 //保存宽度
        ,saveH:200
        ,aspectRatio:313/200 //选取比例
        ,area:'900px' //弹窗宽度
        ,url: '/admin/content/upload/' //上传接口
        ,exts: 'png|jpg|jpeg|gif' //只允许上传压缩文件
        ,data: {
            '_xsrf': get_xsrf(),
            'path': 'arc_thumb',
            'action': 'arc_thumb',
        }
        ,before: function(){
            $('.thumb-add').find('.loading').show()
        }
        ,done: function(res){
            // console.log('res ', res)
            if(res.code == 0){
                $('.field-thumb').val(res.data.path_file)
                var src = '/static/'+res.data.path_file
                $('.thumb-add img').attr('src', src)
            } else {
                layer.msg(res.msg, {icon: 2})
            }
            $('.thumb-add').find('.loading').hide()
        }
        ,error: function(){
            $('.thumb-add').find('.loading').hide()
        }
    })

    layedit.set({
        uploadImage: {
            url: '/admin/content/upload?action=article&path=article&_xsrf='+get_xsrf() //接口url
            ,type: 'post' //默认post
        }
    })
    //注意：layedit.set 一定要放在 build 前面，否则配置全局接口将无效。
    // layedit.build('content')
    var conindex = layedit.build('content', {
        height: 180, //设置编辑器高度
        tool: [
          'strong' //加粗
          ,'italic' //斜体
          ,'underline' //下划线
          ,'del' //删除线
          ,'|' //分割线
          ,'left' //左对齐
          ,'center' //居中对齐
          ,'right' //右对齐
          ,'link' //超链接
          ,'unlink' //清除链接
          ,'face' //表情
          ,'code' //代码
          ,'image' //插入图片
          ,'source' //源代码
          ,'help' //帮助
        ]
    })


    set_form_data(formData)

    if (formData) {
        $('.ass-level').val(parseInt($('.field-category option:selected').attr('level'))+1)
    }

    // 表单验证
    form.verify({
        rolename : [/[A-Za-z0-9\u4e00-\u9fa5]{2,40}$/, '角色名称必须2到40位字母、数字组合或汉字'],
        // password : [/(.+){8,40}$/, '8到40个任意字符'],
        number : [/^[0-9]*$/, '必须输入数字啊']
    })
    form.on('submit(formSubmit)', function(obj) {
        layer.msg('数据提交中...',{time:50000})
        console.log(obj.field)
        obj.field.content = layedit.getContent(conindex)
        // return false
        $.ajax({
            type: "POST",
            url: obj.form.action,
            data: obj.field,
            success: function(res) {
                if (res.code==0) {
                    layer.msg('更新成功', {icon: 1, time: 2000}, function(){
                        parent.edit_success(res.data)
                        var index = parent.layer.getFrameIndex(window.name)
                        parent.layer.close(index)
                    })
                } else if(res.msg) {
                    layer.msg(res.msg)
                } else {
                    layer.msg('{{ _('未知错误') }}')
                }
            },
            error: function(xhr){
                console.log(xhr.responseJSON)
                if (xhr.responseJSON && xhr.responseJSON.msg) {
                    layer.msg(xhr.responseJSON.msg)
                } else {
                    layer.msg('{{ _('未知错误') }}')
                }
            }
        })
        return false
    })

})
</script>
{% end %}